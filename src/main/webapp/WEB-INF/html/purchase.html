<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Foundation | Welcome</title>
    <link rel="stylesheet" href="css/foundation.css"/>
    <link rel="stylesheet" href="css/style.css"/>
    <link rel="stylesheet" href="css/app.css"/>
    <link rel="stylesheet" href="css/font-awesome.css"/>
    <link rel="stylesheet" href="css/responsive-tables.css">
    <link rel="stylesheet" href="css/selectize.default.css">
    <link rel="stylesheet" href="css/foundation-datepicker.min.css">

    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    <script src="js/responsive-tables.js"></script>
    <script src="js/foundation-datepicker.min.js"></script>
    <script src="js/evey-1.0.js"></script>
    <script src="js/angular.js"></script>
    <script src="js/selectize.min.js"></script>
    <script src="js/angular-selectize.js"></script>
    <script src="angular/crudApp.js"></script>
    <script src="angular/crudController.js"></script>
    <script src="js/vendor/modernizr.js"></script>

</head>
<body>
<div class="row">
    <div>
        <div class="off-canvas-wrap" data-offcanvas>
            <div class="inner-wrap">
                <nav class="tab-bar">
                    <section class="left-small">
                        <a class="left-off-canvas-toggle menu-icon"><span></span></a>
                    </section>
                    <section class="middle tab-bar-section">
                        <h1 class="title">Maestro Fedeli</h1>
                    </section>
                    <section class="right-small">
                        <a class="right-off-canvas-toggle menu-icon"><span></span></a>
                    </section>
                </nav>
                <aside class="right-off-canvas-menu">
                    <ul class="off-canvas-list">
                        <li><label>Logged In User</label></li>
                        <li><a href="#" class="canvas"><i class="fa fa-user"></i> &nbsp &nbsp User Profile</a></li>
                        <li><a href="#" class="canvas"><i class="fa fa-sign-out"></i> &nbsp &nbsp Logout</a></li>
                    </ul>
                </aside>
                <aside class="left-off-canvas-menu">
                    <ul class="off-canvas-list">
                        <li><label>Coffee Shop POS</label></li>
                        <li><a href="/dashboard" id="dashboard-off" class="canvas"><i class="fa fa-line-chart"></i> &nbsp &nbsp Dashboard</a></li>
                        <li><a href="/order" id="order-off" class="canvas"><i class="fa fa-shopping-cart"></i> &nbsp &nbsp Orders</a></li>
                        <li><a href="/inventory" id="inventory-off" class="canvas"><i class="fa fa-bar-chart"></i> &nbsp &nbsp Inventory</a></li>
                        <li><a href="/purchase" id="purchase-off" class="canvas"><i class="fa fa-money"></i> &nbsp &nbsp Purchase</a></li>
                        <li><a href="/report" id="report-off" class="canvas"><i class="fa fa-pie-chart"></i>&nbsp &nbsp Reports</a></li>
                        <li class="has-submenu"><a href="#"><i class="fa fa-cogs"></i> &nbsp &nbsp Administration</a>
                            <ul class="left-submenu">
                                <li class="back"><a href="#">Back</a></li>
                                <li><label>Administration Page</label></li>
                                <li class="has-submenu"><a href="#"><i class="fa fa-users"></i>&nbsp &nbsp Accounts</a>
                                    <ul class="left-submenu">
                                        <li class="back"><a href="#">Back</a></li>
                                        <li><label>Account Maintenance</label></li>
                                        <li><a href="/person" id="person-off" class="canvas">People Maintenance</a></li>
                                        <li><a href="/user" id="user-off" class="canvas">User Page</a></li>
                                        <li><a href="/customer" id="customer-off" class="canvas">Customer</a></li>
                                        <li><a href="/supplier" id="supplier-off" class="canvas">Supplier</a></li>
                                        <li><a href="/address" id="address-off" class="canvas">Address</a></li>
                                    </ul>
                                </li>
                                <li class="has-submenu"><a href="#"><i class="fa fa-cog"></i>&nbsp &nbsp System Settings</a>
                                    <ul class="left-submenu">
                                        <li class="back"><a href="#">Back</a></li>
                                        <li><label>System Maintenance</label></li>
                                        <li><a href="/item" id="item-off" class="canvas">Item</a></li>
                                        <li><a href="/product" id="product-off" class="canvas">Product</a></li>
                                        <li><a href="/productGroup" id="product-group-off" class="canvas">Product Group</a></li>
                                        <li><a href="/meal" id="meal-off" class="canvas">Meal</a></li>
                                        <li><a href="/reference" id="reference-off" class="canvas">Reference</a></li>
                                        <li class="has-submenu"><a href="#">Pricing</a>
                                            <ul class="left-submenu">
                                                <li class="back"><a href="#">Back</a></li>
                                                <li><label>Price Maintenance</label></li>
                                                <li><a href="/price" class="canvas">Price List</a></li>
                                                <li><a href="/priceSet" class="canvas">Price Set</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </aside>
                <section class="main-section main-body" ng-app="crudApp" ng-controller="crudController" ng-init="cacheEntities('/reference//getReferenceLookUpByCategory/CATEGORY_UNIT_OF_MEASURE')">
                    <div class="row main-section-row" id="crud-body">
                        <div class="row main-section-row">
                            <div class="small-12 text-align-center">
                                <h4>Purchase</h4>
                            </div>
                        </div>
                        <div class="small-4 large-3  columns search-panel" id="crud-search" >
                            <div class="row">
                                <div class="small-12 columns bar">
                                    <h4><i class="fa fa-search"></i>&nbsp Search</h4>
                                </div>
                            </div>
                            <div class="row">
                                <form>
                                    <div class="small-12 columns">
                                        <label>Purchase Code
                                            <input type="text" placeholder="Purchase Code" name="purchaseCode"/>
                                        </label>
                                        <label>Request Date
                                            <input class="fcalendar" type="text" name="requestDate" placeholder="Request Date">
                                        </label>
                                        <label>Purchase Date
                                            <input class="fcalendar" type="text" name="purchaseDate" placeholder="Purchase Date">
                                        </label>
                                        <label>Receive Datex
                                            <input class="fcalendar" type="text" name="receiveDate" placeholder="Receive Date">
                                        </label>
                                        <div class="rows">
                                            <a href="#" class="button expand" id="search-search-crud-btn" ng-click="test()">Search</a>
                                            <a href="#" class="button secondary expand" id="search-clr-crud-btn">Clear</a>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="small-8 large-9 columns crud-result">
                            <div class="rows">
                                <span> <small>Displaying {{startIndex}} to {{maxItem}} of {{listSize}} records.</small></span>
                                <a href="#" class="button right success small add-purchase-modal"><i class="fa fa-plus-circle"></i> &nbsp Purchase</a>
                            </div>
                            <div class="rows">
                                <div class="small-12 columns">
                                    <table class="max-width" id="crud-table" data-url="/purchase/findAll">
                                        <thead>
                                            <tr>
                                                <th>Purchase Code</th>
                                                <th>Supplier</th>
                                                <th>Price</th>
                                                <th>Request Date</th>
                                                <th>Purchase Date</th>
                                                <th>Receive Date</th>
                                                <th>Ordered By</th>
                                                <th>Status</th>
                                                <th style="width:10%"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="record in records">
                                                <td>{{record.purchaseCode}}</td>
                                                <td>{{record.supplier}}</td>
                                                <td>{{record.totalExpense}}</td>
                                                <td>{{record.displayRequestDate}}</td>
                                                <td>{{record.displayPurchaseDate}}</td>
                                                <td>{{record.displayReceiveDate}}</td>
                                                <td>{{record.createdByUsername}}</td>
                                                <td>{{record.status}}</td>
                                                <td>
                                                    <i class="fa fa-refresh restock-btn fa-2x-for-small fa-lg" ng-click = "editAction(record.id)" ng-class="id"  data-id="{{record.id}}" data-reveal-id="update-modal"></i>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="clearfix"/>
                            <div class="rows">
                                <div class="pagination-centered">
                                    <ul class="pagination" role="menubar" aria-label="Pagination">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="crud-modal" class="reveal-modal crud-modal reveal-modal-absolute" data-reveal aria-labelledby="crud-title" aria-hidden="true" role="dialog">
                        <h3 id="crud-title">Purchase.</h3>
                        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
                        <form data-abide="ajax">
                            <div class="row">
                                <div class="small-12 columns">
                                    <div class="row collapse prefix-radius">
                                        <label>Supplier Name
                                            <input class="supplier-name" type="text" placeholder="Supplier Name" name="supplierName"></label>
                                    </div>
                                    <div class="row collapse prefix-radius">
                                        <div class="columns small-12">
                                            <div class="row">
                                                <div class="columns small-12 add-purchase">

                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="columns small-12 added-purchase">

                                                </div>
                                            </div>
                                            <div class="row margin-top-one-rem">
                                                <a aria-label="Add" class="add-item"><i class="fa fa-plus-circle"></i> Add Item</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="rows">
                                        <button class="button expand success purchase-crud">Purchase</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div id="update-modal" class="reveal-modal crud-modal reveal-modal-absolute" data-reveal aria-labelledby="update-title" aria-hidden="true" role="dialog" data-receival="{{recordFound.isForReceival}}">
                        <h3 id="update-title">Purchase: {{recordFound.purchaseCode}}</h3>
                        <h4 class="center">{{recordFound.status}}</h4>
                        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
                        <form data-abide="ajax">
                            <div class="row">
                                <div class="small-12 columns">
                                    <div class="row">
                                        <input id="purchaseId" type="hidden" value="{{recordFound.id}}" name="id">
                                    </div>
                                    <div class="row collapse prefix-radius">
                                        <label>Supplier Name
                                            <input type="text" placeholder="Supplier Name" name="supplierName" value="{{recordFound.supplier}}" disabled></label>
                                    </div>
                                    <div class="row collapse prefix-radius">
                                        <div class="column small-12">
                                            <div class="row" ng-if="!recordFound.isForReceival">
                                                <div class="columns small-6">
                                                    <label class="center">Item Name</label>
                                                </div>
                                                <div class="columns small-6">
                                                    <label class="center">Request Quantity</label>
                                                </div>
                                            </div>
                                            <div class="row" ng-if="recordFound.isForReceival">
                                                <div class="columns small-5">
                                                    <label class="center">Item Name</label>
                                                </div>
                                                <div class="columns small-4">
                                                    <label class="center">Request Quantity</label>
                                                </div>
                                                <div class="columns small-3">
                                                    <label class="center">Received</label>
                                                </div>
                                            </div>
                                            <div class="ordered-item-location">

                                            </div>
                                        </div>
                                    </div>
                                    <div class="rows" ng-if="!recordFound.isForReceival">
                                        <button class="button expand success restock-action-btn" data-status="In Progress">Purchase</button>
                                    </div>
                                    <div class="rows" ng-if="recordFound.isForReceival">
                                        <button class="button expand success" id="restock-receive-btn">Receive</button>
                                    </div>
                                    <div class="rows">
                                        <button class="button expand alert restock-action-btn" data-status="Cancelled">Cancel Purchase Request</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </section>
                <a class="exit-off-canvas"></a>
            </div>
        </div>
    </div>
</div>
</body>
<footer>

    <script type="text/html" id="purchase-template">
        <div class="row item-row">
            <div class="columns small-8">
                <select class="item-dropdown"></select>
            </div>
            <div class="columns small-3">
                <input class="purc-order-qty" type="number" placeholder="Quantity" name="orderQuantity" pattern="number">
            </div>
            <div class="columns small-1">
                <a class="push-item"><i class="fa fa-plus fa-2x"></i></a>
            </div>
        </div>
    </script>

    <script type="text/html" id="added-purchase-template">
        <div class="row item-added">
            <div class="columns small-8">
                <span class="item"></span>
            </div>
            <div class="columns small-3">
                <span class="purch-order-qty"></span>
            </div>
            <div class="columns small-1">
                <a aria-label="Remove" class="remove-item"><i class="fa fa-times fa-lg"></i></a>
            </div>
        </div>
    </script>

    <script type="text/html" id="ordered-template">
        <div class="row">
            <div class="center columns small-6">
                <span class="item"></span>
            </div>
            <div class="center columns small-6">
                <input type="number" class="request-quantity"/>
            </div>
        </div>
    </script>

    <script type="text/html" id="ordered-receive-template">
        <div class="row">
            <div class="center columns small-5">
                <span class="item"></span>
            </div>
            <div class="center columns small-4">
                <span class="request-quantity"></span>
            </div>
            <div class="center columns small-3">
                <input type="number" class="quantity-received"/>
            </div>
        </div>
    </script>

    <script>
        $(document).foundation();
        $(document).EVEYfy();

        var items = null;
        $(document).ready(function(){

            $.ajax({
                url: evey.getHome()+"/item/getAllBypassLazy",
                type: "GET",
                dataType: "JSON",
                success: function(data){
                    items = data;
                }
            });

        }).on("click", ".restock-btn", function(){
            var purchaseId = $(this).data("id");
            $("#restock-receive-btn").removeClass("hide");

            var location = $(".ordered-item-location");
            $(location).children("div.row").remove();

            $.ajax({
                url: evey.getHome()+"/purchase/findPO",
                data: {"purchaseId": purchaseId},
                type: "GET",
                dataType: "JSON",
                success: function(data){

                    var orderedItem = $("#ordered-template").html();
                    if($("#update-modal").attr("data-receival")!=null
                        && $("#update-modal").attr("data-receival")!=undefined
                        && $("#update-modal").attr("data-receival")==="true") {
                        orderedItem = $("#ordered-receive-template").html();
                    }

                    var entities = angular.element(".main-body").scope().entities[0];

                    var isHideReceiveBtn = true;
                    $.each(data, function(i, po){
                        $(location).append($(orderedItem));
                        var lastRow = $(location).find("div.row").last();

                        var uom = null;
                        for(var i=0; i<entities.length-1; i++){
                            if(po.orderedItem.uomId == entities[i].id){
                                uom = entities[i].value;
                                break;
                            }
                        }

                        $(lastRow).attr("data-id",po.id);
                        $(lastRow).find("span.item").text(po.orderedItem.itemCode +" - "+po.orderedItem.itemName);

                        if($("#update-modal").attr("data-receival")==="true"){
                            $(lastRow).find("span.request-quantity").text(po.orderedQuantity+" "+uom);
                        } else {
                            $(lastRow).find("input.request-quantity").val(po.orderedQuantity);
                        }

                        $(lastRow).find("input.request-price").val(po.price);
                        $(lastRow).find("span.request-price").text(po.price);
                        if(po.isReceived){
                            $(lastRow).find("input.quantity-received").val(po.receivedQuantity);
                            $(lastRow).find("input.quantity-received").attr("disabled", true);

                            $(lastRow).find("input.request-price").attr("disabled", true);
                            isHideReceiveBtn = true;
                        } else{
                            $(lastRow).find("input.quantity-received").removeAttr("disabled");
                            $(lastRow).find("input.request-price").removeAttr("disabled");
                            isHideReceiveBtn = false;
                        }
                    });
                    if(isHideReceiveBtn){
                        $("#restock-receive-btn").addClass("hide");
                    }
                }
            });
        }).on("click",".restock-action-btn", function(){
            var status = $(this).data("status");
            var purchaseId = $("#purchaseId").val();

            $.ajax({
                url: evey.getHome()+"/purchase/update-status",
                data : {"purchaseId":purchaseId, "status": status},
                type: "POST",
                dataType: "JSON",
                success:function(data){
                    console.log(data);
                    $('#update-modal').foundation('reveal', 'close');
                }
            });
        }).on("click", "#restock-receive-btn",function(){
            var purchaseId = $("#purchaseId").val();

            var purchase = new Object();
            var pos = [];
            $.each($("#update-modal .ordered-item-location div.row"),function(i,row){
                var po = new Object();
                po["id"] = $(row).attr("data-id");
                po["receivedQuantity"] = $(row).find(".quantity-received").val();
                pos.push(po);
            });

            purchase["id"] = purchaseId;
            purchase["purchaseOrders"] = pos;

            $.ajax({
                url: evey.getHome()+"/purchase/receive-purchase",
                data : JSON.stringify(purchase),
                type: "POST",
                dataType: "JSON",
                contentType: "application/json",
                success:function(data){
                    console.log(data);
                    $('#update-modal').foundation('reveal', 'close');
                }
            });
        }).on("click", ".add-item", function(){
            var template = $("#purchase-template").html();

            var location = $("#crud-modal .add-purchase");
            $(location).append($(template));
            $(location).find(".item-dropdown").last().selectize({
                valueField: 'id',
                labelField: 'itemName',
                searchField: ['itemName','itemCode'],
                options:items,
                render: {
                    option:function(items){
                        return "<option value='"+items.id+"' data-uom='"+items.uom.value+"'>"+items.itemCode+" - "+items.itemName+"</option>"
                    }
                }
            });
        }).on("click", ".push-item", function(){
            var row = $(this).parents("div.item-row");
            var itemId = $(row).find("select option:selected").val();
            var itemName = $(row).find("select option:selected").text();
            var qty = $(row).find("input.purc-order-qty").val();
            var price = $(row).find("input.purc-price").val();

            var template = $("#added-purchase-template").html();
            var location = $("#crud-modal .added-purchase");

            $(location).append($(template));
            var lastRow = $(location).find("div.row").last();
            $(lastRow).attr("data-itemid", itemId);
            $(lastRow).attr("data-qty", qty);
            $(lastRow).attr("data-price",price);
            $(lastRow).find("span.item").text(itemName);
            $(lastRow).find("span.purch-order-qty").text(qty);
            $(lastRow).find("span.purch-price").text(price);

            $(row).remove();

        }).on("click", ".remove-item", function(){
            $(this).parents(".item-added").remove();
        }).on("click", ".add-purchase-modal", function(){
            $("#crud-modal .add-purchase").children().remove();
            $("#crud-modal .added-purchase").children().remove();
            $('#crud-modal').foundation('reveal', 'open');
        }).on("click", ".purchase-crud", function(){
            var purchaseOrderList = [];
            var purchase = new Object();
            $.each($("#crud-modal .added-purchase .item-added"),function(i,row){
                var purchaseOrder = new Object();
                var item = new Object();
                var itemId = $(row).attr("data-itemid");
                var qty = $(row).attr("data-qty");
                var price = $(row).attr("data-price");

                item["id"] = itemId;
                purchaseOrder["price"] = price;
                purchaseOrder["orderedQuantity"] = qty;
                purchaseOrder["orderedItem"] = item;
                purchaseOrderList.push(purchaseOrder);
            });

            purchase["supplier"] = $("#crud-modal .supplier-name").val();
            purchase["purchaseOrders"] = purchaseOrderList;

            $.ajax({
                url: evey.getHome()+"/purchase/create-purchase",
                data: JSON.stringify(purchase),
                type: "POST",
                dataType: "JSON",
                contentType: "application/json",
                success: function(data){
                    angular.element(".main-body").scope().searchEntity(data.result);
                    angular.element(".main-body").scope().$apply();
                    $('#crud-modal').foundation('reveal', 'close');
                }
            });

        });

        $(".fcalendar").fdatepicker({
            format: 'mm-dd-yyyy',
            disableDblClickSelection: true,
            closeButton: true
        });
    </script>
</footer>
</html>
